<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APK Dropzone</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #0d1117; color: #c9d1d9; }
        .container { background: #161b22; padding: 20px; border-radius: 15px; border: 1px solid #30363d; }
        h2 { text-align: center; color: #58a6ff; }
        
        /* Inputs */
        input { width: 100%; padding: 12px; margin-bottom: 10px; background: #0d1117; border: 1px solid #30363d; color: white; border-radius: 6px; box-sizing: border-box; }
        
        /* Buttons */
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-upload { background: #238636; color: white; }
        .btn-refresh { background: #1f6feb; color: white; margin-bottom: 15px;}
        .btn-delete { background: #da3633; color: white; width: auto; padding: 5px 12px; font-size: 0.8em; }
        .btn-login { background: #30363d; color: #c9d1d9; border: 1px solid #8b949e; margin-top: 10px;}
        
        /* File List */
        .file-list { margin-top: 20px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #21262d; margin-bottom: 10px; border-radius: 8px; border: 1px solid #30363d; }
        .file-name { color: #58a6ff; text-decoration: none; font-weight: bold; word-break: break-all; }
        .file-info { font-size: 0.8em; color: #8b949e; margin-top: 4px; }
        
        /* Visibility Classes */
        .admin-only { display: none; } /* Hidden by default */
        .status { text-align: center; margin-top: 10px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ APK Share System</h2>
    
    <div id="loginSection">
        <p style="font-size: 0.9em; color: #8b949e;">Enter details to enable Upload Mode. (Your friend doesn't need this).</p>
        <input type="text" id="username" placeholder="GitHub Username (e.g. yourname)">
        <input type="text" id="repo" placeholder="Repo Name (e.g. my-apk-storage)">
        <input type="password" id="token" placeholder="Paste Token to Unlock Admin Mode">
        <button class="btn-login" onclick="saveCredentials()">Unlock Admin Mode</button>
    </div>

    <div id="appSection" style="display:none;">
        <p id="welcomeMsg" style="text-align: center; color: #8b949e;"></p>
        
        <div id="adminPanel" class="admin-only">
            <hr style="border-color: #30363d;">
            <h3>üì§ Upload File</h3>
            <input type="file" id="fileInput">
            <button class="btn-upload" onclick="uploadFile()">Upload File</button>
            <div id="uploadStatus" class="status"></div>
            <hr style="border-color: #30363d; margin: 20px 0;">
        </div>

        <h3>üì• Available Files</h3>
        <button class="btn-refresh" onclick="listFiles()">Refresh List</button>
        <div id="fileList" class="file-list"></div>
        
        <button class="btn-login" onclick="logout()" style="margin-top: 30px;">Lock / Logout</button>
    </div>
</div>

<script>
    // Configuration
    let CONFIG = { user: '', repo: '', token: '' };

    // On Load: Check if user is "Admin" (has token saved)
    window.onload = function() {
        const savedUser = localStorage.getItem('gh_user');
        const savedRepo = localStorage.getItem('gh_repo');
        const savedToken = localStorage.getItem('gh_token');

        if (savedUser && savedRepo) {
            CONFIG.user = savedUser;
            CONFIG.repo = savedRepo;
            CONFIG.token = savedToken || ''; // Token might be empty if guest
            
            showApp();
        }
    };

    function saveCredentials() {
        const user = document.getElementById('username').value;
        const repo = document.getElementById('repo').value;
        const token = document.getElementById('token').value;

        if(!user || !repo) return alert("Username and Repo are required!");

        localStorage.setItem('gh_user', user);
        localStorage.setItem('gh_repo', repo);
        if(token) localStorage.setItem('gh_token', token);

        CONFIG = { user, repo, token };
        showApp();
    }

    function showApp() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('appSection').style.display = 'block';
        
        if (CONFIG.token) {
            // ADMIN MODE
            document.getElementById('welcomeMsg').innerText = `üîì Admin Mode: ${CONFIG.user}/${CONFIG.repo}`;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
        } else {
            // GUEST MODE
            document.getElementById('welcomeMsg').innerText = `üëÅÔ∏è Guest Mode: Viewing ${CONFIG.user}/${CONFIG.repo}`;
        }
        
        listFiles();
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }

    // --- CORE FUNCTIONS ---

    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('uploadStatus');
        
        if (!fileInput.files.length) return alert("Select a file!");
        
        const file = fileInput.files[0];
        status.innerText = "‚è≥ Encoding...";

        const reader = new FileReader();
        reader.readAsDataURL(file);
        
        reader.onload = async function() {
            const content = reader.result.split(',')[1];
            status.innerText = "üöÄ Uploading...";

            const url = `https://api.github.com/repos/${CONFIG.user}/${CONFIG.repo}/contents/${file.name}`;
            
            try {
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${CONFIG.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "New APK Upload", content: content })
                });

                if (res.ok) {
                    status.innerText = "‚úÖ Done!";
                    fileInput.value = ''; // Clear input
                    listFiles();
                } else {
                    const err = await res.json();
                    status.innerText = "‚ùå Error: " + err.message;
                }
            } catch (e) { status.innerText = "‚ùå Network Error"; }
        };
    }

    async function listFiles() {
        const listDiv = document.getElementById('fileList');
        listDiv.innerHTML = "<p class='status'>Loading...</p>";

        // If no token, we can still list files if the repo is PUBLIC
        const headers = CONFIG.token ? { 'Authorization': `token ${CONFIG.token}` } : {};
        const url = `https://api.github.com/repos/${CONFIG.user}/${CONFIG.repo}/contents`;

        try {
            const res = await fetch(url, { headers });
            if (!res.ok) throw new Error("Repo not found or private");
            const data = await res.json();

            listDiv.innerHTML = ""; 
            
            data.forEach(file => {
                if(file.type === "file") {
                    let deleteBtn = '';
                    // Only show delete button if we have a token
                    if(CONFIG.token) {
                        deleteBtn = `<button class="btn-delete" onclick="deleteFile('${file.path}', '${file.sha}')">Delete</button>`;
                    }

                    // Calculate file size (approx)
                    const size = (file.size / 1024 / 1024).toFixed(2) + " MB";

                    listDiv.innerHTML += `
                        <div class="file-item">
                            <div>
                                <a href="${file.download_url}" class="file-name" target="_blank">${file.name}</a>
                                <div class="file-info">${size}</div>
                            </div>
                            ${deleteBtn}
                        </div>
                    `;
                }
            });
            
            if(data.length === 0) listDiv.innerHTML = "<p class='status'>No files yet.</p>";

        } catch (e) {
            listDiv.innerHTML = "<p class='status'>‚ùå Could not load files. Is the repo Public?</p>";
        }
    }

    async function deleteFile(path, sha) {
        if(!confirm("Delete this file?")) return;
        
        const url = `https://api.github.com/repos/${CONFIG.user}/${CONFIG.repo}/contents/${path}`;
        
        await fetch(url, {
            method: 'DELETE',
            headers: { 'Authorization': `token ${CONFIG.token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: "Delete file", sha: sha })
        });
        
        listFiles();
    }
</script>

</body>
</html>
